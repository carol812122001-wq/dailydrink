<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘è¶…æ„›å–æ‰‹æ– - 2026 é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            --primary-dark: #005461;
            --primary: #018790;
            --primary-light: #00B7B5;
            --bg-gray: #F4F4F4;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-gray);
            color: #334155;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-card {
            aspect-ratio: 1 / 1.1;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(1, 135, 144, 0.2);
        }

        .active-btn {
            background-color: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 84, 97, 0.6);
            backdrop-filter: blur(8px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        #loadingOverlay {
            position: fixed;
            inset: 0;
            background: var(--bg-gray);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- åŠ è¼‰ç•«é¢ -->
    <div id="loadingOverlay">
        <div class="animate-bounce mb-4 text-4xl">ğŸ¥¤</div>
        <p id="loadingText" class="font-bold text-slate-400 animate-pulse">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</p>
        <p id="errorHint" class="hidden mt-4 text-xs text-rose-400 px-6 text-center">é€£ç·šæ™‚é–“éé•·ï¼Œè«‹ç¢ºèª Firebase çš„ Authentication åŒ¿åç™»å…¥æ˜¯å¦å·²é–‹å•Ÿï¼Œä¸” Firestore è¦å‰‡æ˜¯å¦ç‚ºæ¸¬è©¦æ¨¡å¼ã€‚</p>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-black mb-2" style="color: var(--primary);">ğŸ¥¤ æˆ‘è¶…æ„›å–æ‰‹æ–</h1>
            <div class="flex items-center justify-center gap-2">
                <p class="font-bold tracking-[0.2em] text-sm opacity-60" style="color: var(--primary-dark);">2026 CLOUD SYNC</p>
                <span id="syncStatus" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            </div>
            <p id="userTag" class="text-[10px] mt-2 text-slate-400 font-mono"></p>
        </header>

        <!-- çµ±è¨ˆæ•¸æ“š -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8">
            <div class="p-6 rounded-[2rem] shadow-xl text-white flex flex-col justify-center" style="background: linear-gradient(135deg, var(--primary-dark), var(--primary));">
                <p class="text-xs font-bold opacity-80 mb-2 tracking-widest uppercase">å¹´åº¦ç¸½æ¯æ•¸</p>
                <p id="annualCount" class="text-5xl font-black">0 <span class="text-xl font-normal">æ¯</span></p>
            </div>
            <div class="p-6 rounded-[2rem] shadow-xl text-white flex flex-col justify-center" style="background: linear-gradient(135deg, var(--primary), var(--primary-light));">
                <p class="text-xs font-bold opacity-80 mb-2 tracking-widest uppercase">å¹´åº¦ç¸½èŠ±è²»</p>
                <p id="annualSpending" class="text-5xl font-black"><span class="text-xl font-normal">$</span> 0</p>
            </div>
        </div>

        <!-- æœˆä»½åˆ‡æ› -->
        <div class="flex items-center justify-between mb-6 bg-white p-2 rounded-2xl shadow-sm border border-white">
            <button onclick="changeMonth(-1)" class="w-12 h-12 flex items-center justify-center hover:bg-gray-100 rounded-xl transition font-bold" style="color: var(--primary);">â®</button>
            <h2 id="currentMonthDisplay" class="text-xl font-black text-slate-800">2026å¹´ 1æœˆ</h2>
            <button onclick="changeMonth(1)" class="w-12 h-12 flex items-center justify-center hover:bg-gray-100 rounded-xl transition font-bold" style="color: var(--primary);">â¯</button>
        </div>

        <!-- è¡Œäº‹æ›† -->
        <div id="calendarDays" class="calendar-grid bg-white p-6 rounded-[2.5rem] shadow-sm mb-10 border border-white"></div>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div id="editModal" class="modal px-4">
        <div class="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl max-h-[90vh] overflow-hidden flex flex-col border border-white">
            <div class="p-6 border-b flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase mb-1">ç·¨è¼¯ç´€éŒ„</p>
                    <h3 id="modalDateTitle" class="text-2xl font-black text-slate-800">1æœˆ 1æ—¥</h3>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-full text-slate-400 hover:text-slate-600 transition text-2xl">&times;</button>
            </div>
            
            <div class="p-6 space-y-8 overflow-y-auto flex-1 no-scrollbar">
                <!-- Drink 1 -->
                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="flex items-center text-sm font-black uppercase tracking-widest" style="color: var(--primary);">
                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] mr-2 text-white" style="background-color: var(--primary);">1</span> ç¬¬ä¸€æ¯
                        </span>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-300">$</span>
                            <input type="number" id="price1" placeholder="é‡‘é¡" class="w-24 pl-6 p-2 text-sm bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-teal-500 outline-none font-bold">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="shop1" placeholder="åº—å" class="p-3 text-sm bg-gray-50 border-none rounded-xl outline-none">
                        <input type="text" id="item1" placeholder="å“é …" class="p-3 text-sm bg-gray-50 border-none rounded-xl outline-none">
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase px-1">å†°å¡Š</p>
                        <div class="grid grid-cols-3 gap-1.5" id="iceGroup1">
                            <button onclick="setOption('ice', 1, 'æ­£å¸¸')" class="ice-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">æ­£å¸¸</button>
                            <button onclick="setOption('ice', 1, 'å°‘å†°')" class="ice-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å°‘å†°</button>
                            <button onclick="setOption('ice', 1, 'å¾®å†°')" class="ice-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å¾®å†°</button>
                            <button onclick="setOption('ice', 1, 'å»å†°')" class="ice-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å»å†°</button>
                            <button onclick="setOption('ice', 1, 'å¸¸æº«')" class="ice-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å¸¸æº«</button>
                            <button onclick="setOption('ice', 1, 'æº«')" class="ice-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">æº«</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase px-1">ç”œåº¦</p>
                        <div class="grid grid-cols-3 gap-1.5" id="sugarGroup1">
                            <button onclick="setOption('sugar', 1, 'å…¨ç³–')" class="sugar-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å…¨ç³–</button>
                            <button onclick="setOption('sugar', 1, 'å°‘ç³–')" class="sugar-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å°‘ç³–</button>
                            <button onclick="setOption('sugar', 1, 'åŠç³–')" class="sugar-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">åŠç³–</button>
                            <button onclick="setOption('sugar', 1, 'å¾®ç³–')" class="sugar-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å¾®ç³–</button>
                            <button onclick="setOption('sugar', 1, 'ä¸€åˆ†')" class="sugar-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">ä¸€åˆ†</button>
                            <button onclick="setOption('sugar', 1, 'ç„¡ç³–')" class="sugar-btn-1 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">ç„¡ç³–</button>
                        </div>
                    </div>
                </section>

                <hr class="border-gray-100">

                <!-- Drink 2 -->
                <section class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="flex items-center text-sm font-black uppercase tracking-widest" style="color: var(--primary-light);">
                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-[10px] mr-2 text-white" style="background-color: var(--primary-light);">2</span> ç¬¬äºŒæ¯
                        </span>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-300">$</span>
                            <input type="number" id="price2" placeholder="é‡‘é¡" class="w-24 pl-6 p-2 text-sm bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-teal-500 outline-none font-bold">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="shop2" placeholder="åº—å" class="p-3 text-sm bg-gray-50 border-none rounded-xl outline-none">
                        <input type="text" id="item2" placeholder="å“é …" class="p-3 text-sm bg-gray-50 border-none rounded-xl outline-none">
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase px-1">å†°å¡Š</p>
                        <div class="grid grid-cols-3 gap-1.5" id="iceGroup2">
                            <button onclick="setOption('ice', 2, 'æ­£å¸¸')" class="ice-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">æ­£å¸¸</button>
                            <button onclick="setOption('ice', 2, 'å°‘å†°')" class="ice-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å°‘å†°</button>
                            <button onclick="setOption('ice', 2, 'å¾®å†°')" class="ice-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å¾®å†°</button>
                            <button onclick="setOption('ice', 2, 'å»å†°')" class="ice-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å»å†°</button>
                            <button onclick="setOption('ice', 2, 'å¸¸æº«')" class="ice-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å¸¸æº«</button>
                            <button onclick="setOption('ice', 2, 'æº«')" class="ice-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">æº«</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase px-1">ç”œåº¦</p>
                        <div class="grid grid-cols-3 gap-1.5" id="sugarGroup2">
                            <button onclick="setOption('sugar', 2, 'å…¨ç³–')" class="sugar-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å…¨ç³–</button>
                            <button onclick="setOption('sugar', 2, 'å°‘ç³–')" class="sugar-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å°‘ç³–</button>
                            <button onclick="setOption('sugar', 2, 'åŠç³–')" class="sugar-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">åŠç³–</button>
                            <button onclick="setOption('sugar', 2, 'å¾®ç³–')" class="sugar-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">å¾®ç³–</button>
                            <button onclick="setOption('sugar', 2, 'ä¸€åˆ†')" class="sugar-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">ä¸€åˆ†</button>
                            <button onclick="setOption('sugar', 2, 'ç„¡ç³–')" class="sugar-btn-2 p-2 rounded-lg text-xs bg-gray-50 text-slate-500">ç„¡ç³–</button>
                        </div>
                    </div>
                </section>
            </div>

            <div class="p-6 bg-gray-50 flex gap-3">
                <button onclick="saveData()" id="saveBtn" class="flex-1 text-white font-black py-4 rounded-2xl shadow-lg transition active:scale-95" style="background-color: var(--primary);">å„²å­˜ç´€éŒ„</button>
                <button onclick="clearDay()" class="px-5 py-4 text-rose-400 font-bold bg-white border border-rose-100 rounded-2xl hover:bg-rose-50 transition">æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ========================================================
        // å·²è‡ªå‹•å¡«å…¥æ‚¨æä¾›çš„ Firebase é‡‘é‘°
        // ========================================================
        const mySecretConfig = {
            apiKey: "AIzaSyDMnjKCqJW875oRj3ODCRtOHgenGcHME9M",
            authDomain: "drink-c4589.firebaseapp.com",
            projectId: "drink-c4589",
            storageBucket: "drink-c4589.firebasestorage.app",
            messagingSenderId: "881443734224",
            appId: "1:881443734224:web:f492ffbb397793a50554d5",
            measurementId: "G-9NWQB9L73W"
        };

        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = mySecretConfig;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'my-drink-tracker';

        let currentYear = 2026;
        let currentMonth = new Date().getMonth();
        let selectedDateKey = "";
        let drinkData = {};
        let user = null;
        const tempState = { d1: { ice: "", sugar: "" }, d2: { ice: "", sugar: "" } };

        // ç›£æ§åŠ è¼‰è¶…æ™‚
        const loadTimeout = setTimeout(() => {
            document.getElementById('errorHint').classList.remove('hidden');
        }, 8000);

        window.changeMonth = (delta) => {
            currentMonth += delta;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        };

        window.openModal = (dateKey, dayNum) => {
            selectedDateKey = dateKey;
            document.getElementById('modalDateTitle').innerText = `${currentMonth + 1}æœˆ ${dayNum}æ—¥`;
            const data = drinkData[dateKey] || { d1: {}, d2: {} };
            tempState.d1 = { ice: data.d1?.ice || "", sugar: data.d1?.sugar || "" };
            tempState.d2 = { ice: data.d2?.ice || "", sugar: data.d2?.sugar || "" };
            document.getElementById('shop1').value = data.d1?.shop || "";
            document.getElementById('item1').value = data.d1?.item || "";
            document.getElementById('price1').value = data.d1?.price || "";
            document.getElementById('shop2').value = data.d2?.shop || "";
            document.getElementById('item2').value = data.d2?.item || "";
            document.getElementById('price2').value = data.d2?.price || "";
            refreshActiveButtons();
            document.getElementById('editModal').style.display = 'flex';
        };

        window.setOption = (type, num, val) => {
            tempState[`d${num}`][type] = val;
            refreshActiveButtons();
        };

        function refreshActiveButtons() {
            ['ice', 'sugar'].forEach(type => {
                [1, 2].forEach(num => {
                    const currentVal = tempState[`d${num}`][type];
                    document.querySelectorAll(`.${type}-btn-${num}`).forEach(btn => {
                        btn.classList.toggle('active-btn', btn.innerText === currentVal);
                    });
                });
            });
        }

        window.closeModal = () => document.getElementById('editModal').style.display = 'none';

        window.saveData = async () => {
            if (!user) return;
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerText = "å„²å­˜ä¸­...";

            const d1 = {
                shop: document.getElementById('shop1').value,
                item: document.getElementById('item1').value,
                price: document.getElementById('price1').value,
                ice: tempState.d1.ice,
                sugar: tempState.d1.sugar
            };
            const d2 = {
                shop: document.getElementById('shop2').value,
                item: document.getElementById('item2').value,
                price: document.getElementById('price2').value,
                ice: tempState.d2.ice,
                sugar: tempState.d2.sugar
            };
            
            try {
                const dayDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'drinks', selectedDateKey);
                await setDoc(dayDocRef, { d1, d2, updatedAt: Date.now() });
                closeModal();
            } catch (e) {
                console.error(e);
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æ¬Šé™è¨­å®šï¼");
            } finally {
                btn.disabled = false;
                btn.innerText = "å„²å­˜ç´€éŒ„";
            }
        };

        window.clearDay = async () => {
            if (!user || !confirm("ç¢ºå®šè¦æ¸…ç©ºé€™å¤©çš„ç´€éŒ„å—ï¼Ÿ")) return;
            const dayDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'drinks', selectedDateKey);
            await deleteDoc(dayDocRef);
            closeModal();
        };

        function renderCalendar() {
            const daysContainer = document.getElementById('calendarDays');
            daysContainer.innerHTML = '';
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            document.getElementById('currentMonthDisplay').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            let tCups = 0, tMoney = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const d = drinkData[dateKey];
                const dayDiv = document.createElement('div');
                dayDiv.className = `day-card border rounded-2xl p-1 cursor-pointer flex flex-col items-center justify-between bg-white ${d ? 'border-teal-500 shadow-sm' : 'border-slate-50'}`;
                dayDiv.onclick = () => window.openModal(dateKey, day);
                let icons = "";
                if (d?.d1?.shop || d?.d1?.item) { tCups++; tMoney += Number(d.d1.price || 0); icons += "ğŸ¥¤"; }
                if (d?.d2?.shop || d?.d2?.item) { tCups++; tMoney += Number(d.d2.price || 0); icons += "ğŸ¥¤"; }
                dayDiv.innerHTML = `<span class="text-[10px] font-bold text-slate-300 self-start p-1">${day}</span><span class="text-lg">${icons}</span><span class="h-2"></span>`;
                daysContainer.appendChild(dayDiv);
            }
            document.getElementById('annualCount').innerText = `${tCups} æ¯`;
            document.getElementById('annualSpending').innerText = `$ ${tMoney.toLocaleString()}`;
        }

        onAuthStateChanged(auth, async (u) => {
            if (!u) {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Auth Error:", e);
                    document.getElementById('loadingText').innerText = "é©—è­‰å¤±æ•—ï¼Œè«‹é–‹å•Ÿ Firebase Anonymous Auth";
                }
            } else {
                user = u;
                clearTimeout(loadTimeout);
                document.getElementById('userTag').innerText = `ID: ${u.uid}`;
                const q = collection(db, 'artifacts', appId, 'users', u.uid, 'drinks');
                onSnapshot(q, (snapshot) => {
                    drinkData = {};
                    snapshot.forEach(doc => { drinkData[doc.id] = doc.data(); });
                    renderCalendar();
                    document.getElementById('loadingOverlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 500);
                }, (err) => {
                    console.error("Firestore Error:", err);
                    document.getElementById('loadingText').innerText = "æ¬Šé™ä¸è¶³ï¼Œè«‹æª¢æŸ¥ Firestore è¦å‰‡";
                });
            }
        });
    </script>
</body>
</html>
